# -*- snakemake -*-
from snakemakelib.config import update_config

DEFAULT_RULES = ['star_index', 'star_align', 'star_summarize_alignment_runs']

include: '../../../comp/settings.rules'
include: '../settings.rules'

config_default = { 
    'bio.ngs.align.star' : {
        'cmd' : "STAR",
        'ref' : config['bio.ngs.settings']['db']['ref'],
        'extra_ref' : config['bio.ngs.settings']['db']['extra_ref'],
        'index' : "",
        'rules' : DEFAULT_RULES,
        'star_index': {
            'genome' : "Genome",
        },
    },
}

config = update_config(config_default, config)

try:
    # Update index
    from snakemakelib.bio.ngs.db import index, annotation

    # Update annotation
    config['bio.ngs.align.star']['star_index']['sjdbGTFfile'] = \
        annotation(annotation=config['bio.ngs.align.star']['star_index']['sjdbGTFfile'],\
                   db_cfg=config['bio.ngs.settings']['db'])
    
    config['bio.ngs.align.star']['index'] = index(
        ref = config['bio.ngs.align.star']['ref'],
        index = config['bio.ngs.align.star']['index'],
        application = 'star',
        index_name = config['bio.ngs.align.star']['star_index']['genome'],
        build = config['bio.ngs.settings']['db']['build'])
except:
    pass

if config['bio.ngs.align.star']['extra_ref']:
    include: '../db/ercc.rules'
    include: '../db/cloudbiolinux.rules'

for rule in config['bio.ngs.align.star']['rules']:
    include: os.path.join("star", rule + ".rule")
